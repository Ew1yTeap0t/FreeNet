<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>FreeNet v4.0 - Ultimate Hub</title>
    <style id="user-styles"></style>
    <style>
        :root { --win-bg: #c0c0c0; --win-blue: #000080; }
        body { background: #008080; font-family: 'Tahoma', sans-serif; margin: 0; padding: 10px; overflow: hidden; background-size: cover; }
        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }
        
        .window { width: 950px; background: var(--win-bg); border: 2px solid #fff; border-right: 2px solid #000; border-bottom: 2px solid #000; margin: 0 auto; position: relative; z-index: 10; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); }
        .title-bar { background: linear-gradient(90deg, var(--win-blue), #1084d0); color: white; padding: 4px 8px; font-weight: bold; display: flex; justify-content: space-between; font-size: 12px; }
        
        .tabs { display: flex; background: var(--win-bg); padding: 5px 5px 0 5px; gap: 3px; border-bottom: 2px solid #888; }
        .tab { padding: 6px 12px; border: 1px solid #000; border-bottom: none; cursor: pointer; background: #999; font-size: 11px; color: #fff; }
        .tab.active { background: #eee; color: #000; position: relative; top: 1px; border-bottom: 1px solid #eee; }

        .main-layout { display: flex; gap: 10px; padding: 10px; height: 600px; }
        .sidebar { width: 240px; background: #eee; border: 2px inset #fff; padding: 10px; font-size: 11px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .viewport { flex-grow: 1; background: #fff; border: 2px inset #fff; display: flex; flex-direction: column; overflow: hidden; }
        
        .page { display: none; flex-direction: column; height: 100%; padding: 10px; box-sizing: border-box; }
        .page.active { display: flex; }

        #messages { flex-grow: 1; overflow-y: auto; border: 1px inset #ccc; padding: 10px; font-size: 13px; background: #fff; line-height: 1.4; }
        .msg-img { max-width: 200px; display: block; border: 2px solid #fff; margin-top: 5px; }
        .private-msg { color: #800080; font-style: italic; background: #ffe6ff; padding: 2px; }

        .controls { padding: 5px 0; display: flex; gap: 5px; }
        input, textarea { border: 2px inset #fff; padding: 4px; font-family: 'Tahoma'; font-size: 12px; }
        button { background: var(--win-bg); border: 2px outset #fff; cursor: pointer; font-weight: bold; padding: 4px 10px; font-size: 11px; }
        
        .widget { border: 1px solid #888; background: #ddd; padding: 5px; margin-top: 5px; }
        #clock { font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; color: #000; text-align: center; }
        #typing-status { font-style: italic; color: #555; height: 15px; font-size: 10px; }
    </style>
</head>
<body>

<canvas id="snow-canvas"></canvas>

<div class="window">
    <div class="title-bar"><span>FreeNet_OS_v4.exe</span><span>[?] [X]</span></div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('tab-chat')">Общий чат</div>
        <div class="tab" onclick="switchTab('tab-cinema')">Кинозал</div>
        <div class="tab" onclick="switchTab('tab-paint')">Граффити</div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="widget">
                <div id="clock">00:00:00</div>
                <div style="text-align:center; font-size:9px;">MSK TIME</div>
            </div>

            <img id="view-ava" src="https://via.placeholder.com/150" style="width:100%; border:2px inset #fff; background: #fff;">
            <strong>Ник:</strong>
            <input type="text" id="nick" value="User">
            <strong>Аватар (URL):</strong>
            <input type="text" id="ava-url" oninput="document.getElementById('view-ava').src=this.value">
            
            <div class="widget">
                <strong>Статистика:</strong>
                <div>Сообщений: <span id="msg-count">0</span></div>
                <div>Онлайн: <span id="online-count">1</span></div>
            </div>

            <div class="widget">
                <strong>Lo-Fi Радио:</strong>
                <audio id="radio" src="https://stream.zeno.fm/0r0xa792kwzuv" preload="none"></audio>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button onclick="document.getElementById('radio').play()">▶</button>
                    <button onclick="document.getElementById('radio').pause()">⏸</button>
                    <input type="range" min="0" max="1" step="0.1" oninput="document.getElementById('radio').volume=this.value">
                </div>
            </div>

            <button onclick="applyDesign()" style="background:#ffcc00;">ОБНОВИТЬ ВИД</button>
            <input type="text" id="bg-url" placeholder="Фон URL">
            <div id="status" style="color: orange; font-weight: bold;">• ПОИСК СЕТИ...</div>
            <div id="typing-status"></div>
        </div>

        <div class="viewport">
            <div id="tab-chat" class="page active">
                <div id="messages"></div>
                <div class="controls">
                    <input type="text" id="msg-input" placeholder="Напиши что-нибудь... (/w ник для привата)" style="flex-grow: 1;" onkeypress="handleTyping(event)">
                    <button onclick="sendMsg()">SEND</button>
                </div>
            </div>

            <div id="tab-cinema" class="page">
                <input type="text" id="v-url" placeholder="YouTube Link (https://...)"><button onclick="loadVid()">ЗАГРУЗИТЬ</button>
                <div id="video-container" style="height:350px; background:#000; margin-top:10px; display:flex; align-items:center; justify-content:center; color:white;">Экран готов</div>
            </div>

            <div id="tab-paint" class="page">
                <div class="controls">
                    Цвет: <input type="color" id="p-color">
                    <button onclick="ctx.clearRect(0,0,900,600)">ОЧИСТИТЬ ХОЛСТ</button>
                </div>
                <canvas id="paint-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const wsUrl = "wss://free.blr2.piesocket.com/v3/freenet-room?api_key=0iYPnJ73GIaHA4RqdncbL65VJjQcjXxBidYb8K6B&notify_self=1";
    let socket;
    let msgCounter = 0;
    let typingTimer;

    // --- ЧАСЫ МСК ---
    function updateClock() {
        const now = new Date();
        const msk = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3 * 3600000));
        document.getElementById('clock').innerText = msk.toTimeString().split(' ')[0];
    }
    setInterval(updateClock, 1000);

    // --- СЕТЬ ---
    function connect() {
        socket = new WebSocket(wsUrl);
        socket.onopen = () => {
            document.getElementById('status').innerText = "• В СЕТИ";
            document.getElementById('status').style.color = "green";
        };
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if(data.type === "typing") {
                if(data.nick !== document.getElementById('nick').value) {
                    document.getElementById('typing-status').innerText = `${data.nick} печатает...`;
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => { document.getElementById('typing-status').innerText = ""; }, 2000);
                }
                return;
            }

            processMessage(data);
        };
        socket.onclose = () => { setTimeout(connect, 2000); };
    }

    function processMessage(data) {
        const myNick = document.getElementById('nick').value;
        const box = document.getElementById('messages');
        
        // Логика привата
        if(data.msg.startsWith('/w ')) {
            const parts = data.msg.split(' ');
            const target = parts[1];
            const content = parts.slice(2).join(' ');
            if(target !== myNick && data.nick !== myNick) return; // Не нам
            renderMsg(data, content, true);
        } else {
            renderMsg(data, data.msg, false);
        }
        
        msgCounter++;
        document.getElementById('msg-count').innerText = msgCounter;
        playSoftBeep();
    }

    function renderMsg(data, text, isPrivate) {
        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = isPrivate ? "private-msg" : "";
        
        // Проверка на картинку
        let content = text;
        const imgReg = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i;
        if(imgReg.test(text)) {
            content = text.replace(imgReg, '<img src="$1" class="msg-img">');
        }

        const label = isPrivate ? `[Шепот от ${data.nick}]: ` : `<b>${data.nick}:</b> `;
        div.innerHTML = `<img src="${data.ava}" width="16" height="16" style="vertical-align:middle"> ${label} ${content}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if (socket.readyState === 1 && inp.value.trim()) {
            socket.send(JSON.stringify({
                nick: document.getElementById('nick').value,
                msg: inp.value,
                ava: document.getElementById('ava-url').value || 'https://via.placeholder.com/16'
            }));
            inp.value = "";
        }
    }

    function handleTyping(e) {
        if(e.key === 'Enter') { sendMsg(); return; }
        if(socket.readyState === 1) {
            socket.send(JSON.stringify({ type: "typing", nick: document.getElementById('nick').value }));
        }
    }

    function playSoftBeep() {
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            osc.connect(gain); gain.connect(context.destination);
            osc.frequency.value = 600; gain.gain.value = 0.01;
            osc.start(); osc.stop(context.currentTime + 0.1);
        } catch(e) {}
    }

    // --- ОСТАЛЬНОЙ ФУНКЦИОНАЛ ---
    function switchTab(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'tab-paint') { 
            const c = document.getElementById('paint-canvas');
            c.width = c.parentElement.clientWidth - 20; c.height = 400;
        }
    }

    function applyDesign() {
        const bg = document.getElementById('bg-url').value;
        if(bg) document.body.style.backgroundImage = `url('${bg}')`;
    }

    function loadVid() {
        const url = document.getElementById('v-url').value;
        const id = url.match(/(?:v=|be\/|embed\/)([a-zA-Z0-9_-]{11})/);
        if(id) document.getElementById('video-container').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id[1]}" frameborder="0" allowfullscreen></iframe>`;
    }

    const canvas = document.getElementById('paint-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.onmousedown = () => drawing = true;
    window.onmouseup = () => { drawing = false; ctx.beginPath(); };
    canvas.onmousemove = (e) => {
        if(!drawing) return;
        const r = canvas.getBoundingClientRect();
        ctx.strokeStyle = document.getElementById('p-color').value;
        ctx.lineWidth = 3; ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
        ctx.stroke();
    };

    const snow = document.getElementById('snow-canvas');
    const sctx = snow.getContext('2d');
    let flakes = [];
    function resize() { snow.width = window.innerWidth; snow.height = window.innerHeight; }
    window.onresize = resize; resize();
    for(let i=0; i<70; i++) flakes.push({x: Math.random()*2000, y: Math.random()*1000, r: Math.random()*2+1});
    function loop() {
        sctx.clearRect(0,0,snow.width,snow.height);
        sctx.fillStyle = "rgba(255,255,255,0.8)";
        flakes.forEach(f => {
            sctx.beginPath(); sctx.arc(f.x, f.y, f.r, 0, Math.PI*2); sctx.fill();
            f.y += 1; if(f.y > snow.height) f.y = -5;
        });
        requestAnimationFrame(loop);
    }

    connect(); loop();
</script>
</body>
</html>
