<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>FreeNet v4.3 - Pro Edition</title>
    <style id="user-styles"></style>
    <style>
        :root { --win-bg: #c0c0c0; --win-blue: #000080; }
        body { background: #008080; font-family: 'Tahoma', sans-serif; margin: 0; padding: 10px; overflow: hidden; background-size: cover; background-position: center; }
        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }
        
        .window { width: 950px; background: var(--win-bg); border: 2px solid #fff; border-right: 2px solid #000; border-bottom: 2px solid #000; margin: 0 auto; position: relative; z-index: 10; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); }
        .title-bar { background: linear-gradient(90deg, var(--win-blue), #1084d0); color: white; padding: 4px 8px; font-weight: bold; display: flex; justify-content: space-between; font-size: 12px; }
        
        .tabs { display: flex; background: var(--win-bg); padding: 5px 5px 0 5px; gap: 3px; border-bottom: 2px solid #888; }
        .tab { padding: 6px 12px; border: 1px solid #000; border-bottom: none; cursor: pointer; background: #999; font-size: 11px; color: #fff; }
        .tab.active { background: #eee; color: #000; position: relative; top: 1px; border-bottom: 1px solid #eee; }

        .main-layout { display: flex; gap: 10px; padding: 10px; height: 600px; }
        .sidebar { width: 240px; background: #eee; border: 2px inset #fff; padding: 10px; font-size: 11px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .viewport { flex-grow: 1; background: #fff; border: 2px inset #fff; display: flex; flex-direction: column; overflow: hidden; }
        
        .page { display: none; flex-direction: column; height: 100%; padding: 10px; box-sizing: border-box; }
        .page.active { display: flex; }

        #messages { flex-grow: 1; overflow-y: auto; border: 1px inset #ccc; padding: 10px; font-size: 13px; background: #fff; line-height: 1.4; }
        .msg-img { max-width: 200px; display: block; border: 2px solid #fff; margin-top: 5px; }
        .private-msg { color: #800080; font-style: italic; background: #ffe6ff; padding: 2px; }

        .controls { padding: 5px 0; display: flex; gap: 5px; }
        input, textarea { border: 2px inset #fff; padding: 4px; font-family: 'Tahoma'; font-size: 12px; }
        button { background: var(--win-bg); border: 2px outset #fff; cursor: pointer; font-weight: bold; padding: 4px 10px; font-size: 11px; }
        
        .widget { border: 1px solid #888; background: #ddd; padding: 5px; margin-top: 5px; }
        #clock { font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; color: #000; text-align: center; }
        #typing-status { font-style: italic; color: #555; height: 15px; font-size: 10px; }

        /* Board Style */
        .board-item { background: #fff8dc; border: 1px solid #daa520; padding: 8px; margin-bottom: 10px; position: relative; box-shadow: 2px 2px 0 #888; }
        .del-btn { position: absolute; top: 2px; right: 2px; cursor: pointer; color: red; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>

<canvas id="snow-canvas"></canvas>

<div class="window">
    <div class="title-bar"><span>FreeNet_Markdown_Board.exe</span><span>[?] [X]</span></div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('tab-chat')">Чат</div>
        <div class="tab" onclick="switchTab('tab-board')">Доска объявлений</div>
        <div class="tab" onclick="switchTab('tab-cinema')">Кинозал</div>
        <div class="tab" onclick="switchTab('tab-paint')">Граффити</div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="widget">
                <div id="clock">00:00:00</div>
                <div style="text-align:center; font-size:9px;">MSK TIME</div>
            </div>

            <img id="view-ava" src="https://via.placeholder.com/150" style="width:100%; border:2px inset #fff; background: #fff;">
            
            <strong>Ник и цвет:</strong>
            <div style="display:flex; gap:2px;">
                <input type="text" id="nick" value="User" onchange="saveProfile()">
                <input type="color" id="nick-color" value="#000000" onchange="saveProfile()" title="Цвет ника">
            </div>

            <strong>Аватар (URL):</strong>
            <input type="text" id="ava-url" oninput="updateAvaPreview()" onchange="saveProfile()">
            
            <div class="widget">
                <strong>Инфо:</strong>
                <div>Постов: <span id="msg-count">0</span></div>
                <div>Сеть: <span id="status" style="color:orange">...</span></div>
            </div>

            <strong>Фон URL:</strong>
            <input type="text" id="bg-url" placeholder="Вставь ссылку" onchange="applyDesign(); saveProfile();">
            <button onclick="applyDesign(); saveProfile();" style="background:#ffcc00; color: #000; margin-top: 5px;">СОХРАНИТЬ ВИД</button>
            
            <div id="typing-status"></div>
        </div>

        <div class="viewport">
            <div id="tab-chat" class="page active">
                <div id="messages"></div>
                <div class="controls">
                    <input type="text" id="msg-input" placeholder="**болд** *курсив* ~~дел~~" style="flex-grow: 1;" onkeypress="handleTyping(event)">
                    <button onclick="sendMsg()">SEND</button>
                </div>
            </div>

            <div id="tab-board" class="page">
                <div class="controls" style="flex-direction:column; background:#eee; padding:10px; border-bottom:1px solid #888;">
                    <textarea id="board-input" placeholder="Текст объявления..." rows="2"></textarea>
                    <button onclick="addBoardItem()" style="margin-top:5px; width:100%">ОПУБЛИКОВАТЬ</button>
                </div>
                <div id="board-list" style="flex-grow:1; overflow-y:auto; padding:10px;"></div>
            </div>

            <div id="tab-cinema" class="page">
                <input type="text" id="v-url" placeholder="YouTube Link"><button onclick="loadVid()">OK</button>
                <div id="video-container" style="height:350px; background:#000; margin-top:10px; display:flex; align-items:center; justify-content:center; color:white;">Экран</div>
            </div>

            <div id="tab-paint" class="page">
                <div class="controls">
                    <input type="color" id="p-color">
                    <button onclick="ctx.clearRect(0,0,900,600)">CLEAR</button>
                </div>
                <canvas id="paint-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const wsUrl = "wss://free.blr2.piesocket.com/v3/freenet-room?api_key=0iYPnJ73GIaHA4RqdncbL65VJjQcjXxBidYb8K6B&notify_self=1";
    let socket;
    let msgCounter = 0;
    let typingTimer;

    // --- ФОРМАТИРОВАНИЕ MARKDOWN ---
    function parseMarkdown(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<i>$1</i>')
            .replace(/~~(.*?)~~/g, '<strike>$1</strike>');
    }

    // --- ДОСКА ОБЪЯВЛЕНИЙ (LOCAL) ---
    function addBoardItem() {
        const input = document.getElementById('board-input');
        if(!input.value.trim()) return;
        const items = JSON.parse(localStorage.getItem('freenet_board') || '[]');
        items.unshift({ id: Date.now(), text: input.value, nick: document.getElementById('nick').value });
        localStorage.setItem('freenet_board', JSON.stringify(items));
        input.value = "";
        renderBoard();
    }

    function renderBoard() {
        const list = document.getElementById('board-list');
        const items = JSON.parse(localStorage.getItem('freenet_board') || '[]');
        list.innerHTML = items.map(i => `
            <div class="board-item">
                <span class="del-btn" onclick="deleteBoardItem(${i.id})">[X]</span>
                <small><b>${i.nick}:</b></small><br>${parseMarkdown(i.text)}
            </div>
        `).join('');
    }

    function deleteBoardItem(id) {
        let items = JSON.parse(localStorage.getItem('freenet_board') || '[]');
        items = items.filter(i => i.id !== id);
        localStorage.setItem('freenet_board', JSON.stringify(items));
        renderBoard();
    }

    // --- ПРОФИЛЬ ---
    function saveProfile() {
        const profile = {
            nick: document.getElementById('nick').value,
            color: document.getElementById('nick-color').value,
            ava: document.getElementById('ava-url').value,
            bg: document.getElementById('bg-url').value
        };
        localStorage.setItem('freenet_v4_pro', JSON.stringify(profile));
    }

    function loadProfile() {
        const saved = localStorage.getItem('freenet_v4_pro');
        if (saved) {
            const p = JSON.parse(saved);
            document.getElementById('nick').value = p.nick || "User";
            document.getElementById('nick-color').value = p.color || "#000000";
            document.getElementById('ava-url').value = p.ava || "";
            document.getElementById('bg-url').value = p.bg || "";
            applyDesign(false);
        }
    }

    // --- ЧАСЫ ---
    function updateClock() {
        const msk = new Date(new Date().getTime() + (new Date().getTimezoneOffset() * 60000) + (3 * 3600000));
        document.getElementById('clock').innerText = msk.toTimeString().split(' ')[0];
    }
    setInterval(updateClock, 1000);

    // --- СЕТЬ ---
    function connect() {
        socket = new WebSocket(wsUrl);
        socket.onopen = () => { document.getElementById('status').innerText = "ONLINE"; document.getElementById('status').style.color = "green"; };
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === "typing") {
                if(data.nick !== document.getElementById('nick').value) {
                    document.getElementById('typing-status').innerText = `${data.nick} печатает...`;
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => { document.getElementById('typing-status').innerText = ""; }, 2000);
                }
                return;
            }
            processMessage(data);
        };
        socket.onclose = () => { setTimeout(connect, 2000); };
    }

    function processMessage(data) {
        const myNick = document.getElementById('nick').value;
        const box = document.getElementById('messages');
        const div = document.createElement('div');
        
        let text = data.msg || "";
        let isPrivate = false;
        if(text.startsWith('/w ')) {
            const parts = text.split(' ');
            if(parts[1] !== myNick && data.nick !== myNick) return;
            text = parts.slice(2).join(' ');
            isPrivate = true;
            div.className = "private-msg";
        }

        let content = parseMarkdown(text);
        const imgReg = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i;
        if(imgReg.test(text)) content = content.replace(imgReg, '<img src="$1" class="msg-img">');

        const nickStyle = `style="color:${data.nColor || '#000'}; font-weight:bold"`;
        const label = isPrivate ? `[Шепот от <span ${nickStyle}>${data.nick}</span>]: ` : `<span ${nickStyle}>${data.nick}:</span> `;
        
        div.innerHTML = `<img src="${data.ava}" width="16" height="16" style="vertical-align:middle"> ${label} ${content}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        msgCounter++; document.getElementById('msg-count').innerText = msgCounter;
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if (socket.readyState === 1 && inp.value.trim()) {
            socket.send(JSON.stringify({
                nick: document.getElementById('nick').value,
                nColor: document.getElementById('nick-color').value,
                msg: inp.value,
                ava: document.getElementById('ava-url').value || 'https://via.placeholder.com/16'
            }));
            inp.value = "";
        }
    }

    function handleTyping(e) {
        if(e.key === 'Enter') sendMsg();
        else if(socket.readyState === 1) socket.send(JSON.stringify({ type: "typing", nick: document.getElementById('nick').value }));
    }

    // --- ИНТЕРФЕЙС ---
    function updateAvaPreview() { document.getElementById('view-ava').src = document.getElementById('ava-url').value || 'https://via.placeholder.com/150'; }
    function applyDesign(save = true) {
        const bg = document.getElementById('bg-url').value;
        if(bg) document.body.style.backgroundImage = `url('${bg}')`;
        updateAvaPreview();
        if(save) saveProfile();
    }
    function switchTab(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'tab-paint') { const c = document.getElementById('paint-canvas'); c.width = c.parentElement.clientWidth - 20; c.height = 400; }
    }
    function loadVid() {
        const id = document.getElementById('v-url').value.match(/(?:v=|be\/|embed\/)([a-zA-Z0-9_-]{11})/);
        if(id) document.getElementById('video-container').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id[1]}" frameborder="0" allowfullscreen></iframe>`;
    }

    const canvas = document.getElementById('paint-canvas');
    const ctx = canvas.getContext('2d');
    let draw = false;
    canvas.onmousedown = () => draw = true;
    window.onmouseup = () => { draw = false; ctx.beginPath(); };
    canvas.onmousemove = (e) => {
        if(!draw) return;
        const r = canvas.getBoundingClientRect();
        ctx.strokeStyle = document.getElementById('p-color').value;
        ctx.lineWidth = 3; ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
        ctx.stroke();
    };

    const snow = document.getElementById('snow-canvas');
    const sctx = snow.getContext('2d');
    let flakes = [];
    function resize() { snow.width = window.innerWidth; snow.height = window.innerHeight; }
    window.onresize = resize; resize();
    for(let i=0; i<70; i++) flakes.push({x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*2+1});
    function loop() {
        sctx.clearRect(0,0,snow.width,snow.height); sctx.fillStyle = "rgba(255,255,255,0.8)";
        flakes.forEach(f => { sctx.beginPath(); sctx.arc(f.x, f.y, f.r, 0, Math.PI*2); sctx.fill(); f.y += 1; if(f.y > snow.height) f.y = -5; });
        requestAnimationFrame(loop);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        renderBoard();
        connect();
        loop();
        updateClock();
    });
</script>
</body>
</html>
