<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FreeNet Aero OS v8.0</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#004e92">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZyZWVOZXQgQWVybyIsCiAgInNob3J0X25hbWUiOiAiRnJlZU5ldCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDA0ZTkyIiwKICAidGhlbWVfY29sb3IiOiAiIzAwNGU5MiIsCiAgImljb25zIjogW3sgInNyYyI6ICJodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMTkyLzAwNGU5Mi9mZmZmZmY/dGV4dD1GTiIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiB9XQp9">

    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script> <style id="custom-css-style"></style>
    <style id="theme-logic-style"></style>
    <style>
        :root {
            --aero-bg: rgba(255, 255, 255, 0.35);
            --aero-border: rgba(255, 255, 255, 0.5);
            --win-blue: #1b5ead;
            --font-main: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            font-family: var(--font-main);
            background: #008080 url('https://wallpaperaccess.com/full/1155027.jpg') no-repeat center center fixed;
            background-size: cover;
            transition: background 0.5s ease;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Ñ–æ–Ω–∞ */
        #fx-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 1; }

        /* –°—Ç–µ–∫–ª–æ Aero */
        .glass {
            background: var(--aero-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--aero-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), inset 0 0 15px rgba(255,255,255,0.2);
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        }
        .auth-card { width: 350px; padding: 40px; border-radius: 25px; text-align: center; color: #000; }

        /* –®–∞–ø–∫–∞ –¥–ª—è –º–æ–±–∏–ª–æ–∫ –∏ –ü–ö */
        .app-header {
            height: 55px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; position: relative;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .desktop-window {
            width: 96%; max-width: 1300px; height: 85vh; margin: 10px auto;
            display: flex; flex-direction: column; border-radius: 12px; overflow: hidden;
            position: relative; z-index: 10;
        }

        .main-content { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }

        /* –°–∞–π–¥–±–∞—Ä / –ü—Ä–æ—Ñ–∏–ª—å */
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 10px; }
        .user-panel { padding: 20px; text-align: center; border-radius: 15px; }
        .user-panel img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #fff; object-fit: cover; cursor: pointer; }
        .status-text { font-size: 12px; color: #333; margin-top: 5px; font-style: italic; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .viewport { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .tabs-nav { 
            display: flex; gap: 5px; padding: 5px; background: rgba(0,0,0,0.1); 
            border-radius: 10px; margin-bottom: 10px; overflow-x: auto;
        }
        .tab-btn {
            padding: 8px 15px; border: none; background: transparent; 
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;
            white-space: nowrap; transition: 0.2s;
        }
        .tab-btn.active { background: #fff; color: var(--win-blue); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }

        .page { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .page.active { display: flex; }

        /* –ß–∞—Ç */
        #chat-messages {
            flex: 1; background: rgba(255,255,255,0.6); border-radius: 10px;
            padding: 15px; overflow-y: auto; margin-bottom: 10px;
        }
        .msg-obj { margin-bottom: 15px; display: flex; gap: 10px; }
        .msg-ava { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }
        .msg-body { background: #fff; padding: 8px 12px; border-radius: 12px; color: #000; position: relative; min-width: 60px; }
        .msg-nick { font-size: 11px; font-weight: bold; color: var(--win-blue); margin-bottom: 3px; }
        .is-typing { font-size: 11px; color: #555; height: 15px; margin-bottom: 5px; }

        /* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .input-area { display: flex; gap: 8px; }
        input, textarea, select { 
            padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); outline: none;
        }
        .btn-aero {
            background: linear-gradient(to bottom, #4facfe, #00f2fe);
            border: none; padding: 10px 20px; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer;
        }

        /* –†–∏—Å–æ–≤–∞–ª–∫–∞ */
        .paint-wrap { flex: 1; position: relative; background: #fff; border-radius: 10px; overflow: hidden; }
        #paint-canvas { cursor: crosshair; transform-origin: 0 0; }

        /* –ö–∏–Ω–æ –∫–æ–º–Ω–∞—Ç—ã */
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .room-card { padding: 20px; text-align: center; cursor: pointer; border-radius: 12px; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { width: 280px; padding: 15px; border-radius: 12px; color: #000; animation: slideIn 0.3s ease; }

        /* –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä */
        .music-bar { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-trigger { cursor: pointer; transition: transform 0.3s; }
        .settings-trigger:hover { transform: rotate(90deg); }

        /* –ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥ */
        @media (max-width: 768px) {
            .desktop-window { width: 100%; height: 100vh; margin: 0; border-radius: 0; }
            .sidebar { display: none; }
            .app-header { background: var(--aero-bg); backdrop-filter: blur(10px); }
        }
    </style>
</head>
<body>

<canvas id="fx-canvas"></canvas>

<div id="auth-overlay">
    <div class="auth-card glass">
        <h1 style="margin-top:0">FreeNet Aero</h1>
        <input type="text" id="auth-nick" placeholder="–í–∞—à –Ω–∏–∫" style="width: 80%; margin-bottom: 10px;">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="width: 80%; margin-bottom: 20px;">
        <button class="btn-aero" style="width: 90%" onclick="app.auth()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
        <p id="auth-err" style="color: maroon; font-size: 12px;"></p>
    </div>
</div>

<header class="app-header glass">
    <div style="display:flex; align-items:center; gap:15px">
        <strong style="color:#000; font-size:18px;">FreeNet 8.0</strong>
        <div class="music-bar">
            <span id="now-playing" style="font-size:11px; max-width:100px; overflow:hidden;">Music Off</span>
            <button onclick="app.music.prev()" style="background:none; border:none; cursor:pointer;">‚èÆ</button>
            <button onclick="app.music.toggle()" id="play-btn" style="background:none; border:none; cursor:pointer;">‚ñ∂</button>
            <button onclick="app.music.next()" style="background:none; border:none; cursor:pointer;">‚è≠</button>
        </div>
    </div>
    <div style="display:flex; align-items:center; gap:20px">
        <span id="clock" style="color:#000; font-weight:bold; letter-spacing:1px;">00:00:00</span>
        <span class="settings-trigger" onclick="app.ui.openSettings()">‚öôÔ∏è</span>
    </div>
</header>

<div class="desktop-window glass">
    <div class="main-content">
        <div class="sidebar">
            <div class="user-panel glass">
                <img id="my-ava" src="https://via.placeholder.com/90" onclick="app.ui.editProfile()">
                <h3 id="my-nick" style="margin:10px 0 0 0">...</h3>
                <div id="my-desc" class="status-text">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è</div>
                <hr style="opacity:0.2; margin:15px 0">
                <div style="text-align:left; font-size:11px;">
                    <b>–ú–æ–π —Ñ–æ–Ω:</b> <input type="text" id="set-bg" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" onchange="app.user.update('bg', this.value)" style="width:90%; padding:4px; font-size:10px; margin-top:4px;">
                    <b style="display:block; margin-top:8px;">–ú–æ—è –∞–≤–∞:</b> <input type="text" id="set-ava" placeholder="URL –∞–≤—ã" onchange="app.user.update('ava', this.value)" style="width:90%; padding:4px; font-size:10px;">
                </div>
            </div>
            
            <div class="glass" style="padding:15px; flex:1; overflow-y:auto;">
                <b>–°–µ–π—á–∞—Å –≤ —Å–µ—Ç–∏:</b>
                <div id="online-list" style="margin-top:10px; font-size:13px;"></div>
            </div>
        </div>

        <div class="viewport">
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="app.ui.tab('chat')">–ß–∞—Ç</button>
                <button class="tab-btn" onclick="app.ui.tab('friends')">–î—Ä—É–∑—å—è</button>
                <button class="tab-btn" onclick="app.ui.tab('cinema')">–ö–∏–Ω–æ</button>
                <button class="tab-btn" onclick="app.ui.tab('paint')">–†–∏—Å–æ–≤–∞–Ω–∏–µ</button>
                <button class="tab-btn" onclick="app.ui.tab('games')">–ò–≥—Ä—ã</button>
                <button class="tab-btn" onclick="app.ui.tab('css')">–°—Ç–∏–ª—å</button>
            </div>

            <div id="page-chat" class="page active">
                <div id="chat-messages"></div>
                <div id="typing-notify" class="is-typing"></div>
                <div class="input-area">
                    <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1" oninput="app.chat.typing()" onkeypress="if(event.key==='Enter') app.chat.send()">
                    <button class="btn-aero" onclick="app.chat.send()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                </div>
            </div>

            <div id="page-friends" class="page">
                <div id="friends-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px;"></div>
            </div>

            <div id="page-cinema" class="page">
                <div id="cinema-lobby">
                    <div style="margin-bottom:20px; display:flex; gap:10px;">
                        <button class="btn-aero" onclick="app.cinema.createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    </div>
                    <div id="room-list" class="room-grid"></div>
                </div>
                <div id="cinema-room" style="display:none; flex:1; flex-direction:column;">
                    <div class="input-area" style="margin-bottom:10px;">
                        <input type="text" id="yt-url" placeholder="YouTube —Å—Å—ã–ª–∫–∞" style="flex:1">
                        <button class="btn-aero" onclick="app.cinema.loadVideo()">LOAD</button>
                        <button class="btn-aero" style="background:maroon" onclick="app.cinema.leave()">–í–´–ô–¢–ò</button>
                    </div>
                    <div id="player-container" style="flex:1.5; background:#000; border-radius:10px; overflow:hidden;"></div>
                    <div id="room-chat" style="flex:1; background:rgba(0,0,0,0.05); margin-top:10px; display:flex; flex-direction:column;">
                        <div id="room-messages" style="flex:1; overflow-y:auto; padding:10px; font-size:13px;"></div>
                        <input type="text" id="room-input" placeholder="–ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã..." onkeypress="if(event.key==='Enter') app.cinema.sendChat()">
                    </div>
                </div>
            </div>

            <div id="page-paint" class="page">
                <div style="background:rgba(255,255,255,0.5); padding:10px; display:flex; gap:10px; align-items:center; border-radius:10px 10px 0 0;">
                    <input type="color" id="paint-color" value="#1b5ead">
                    <input type="range" id="paint-size" min="1" max="50" value="5" title="–†–∞–∑–º–µ—Ä">
                    <button class="btn-aero" onclick="app.paint.setTool('brush')">–ö–∏—Å—Ç—å</button>
                    <button class="btn-aero" style="background:#666" onclick="app.paint.setTool('eraser')">–õ–∞—Å—Ç–∏–∫</button>
                    <button class="btn-aero" style="background:maroon" onclick="app.paint.clear()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <span style="font-size:12px">–ö–æ–ª–µ—Å–æ –º—ã—à–∏: –ó—É–º</span>
                </div>
                <div class="paint-wrap" id="paint-container">
                    <canvas id="paint-canvas"></canvas>
                </div>
            </div>

            <div id="page-games" class="page">
                <div class="room-grid">
                    <div class="room-card glass" onclick="app.games.play('ageofwar')">Age of War</div>
                    <div class="room-card glass" onclick="app.games.play('sfh')">Strike Force Heroes</div>
                    <div class="room-card glass" onclick="app.games.play('happywheels')">Happy Wheels</div>
                </div>
                <div id="game-stage" style="display:none; position:fixed; inset:0; z-index:2000; background:#000;">
                    <button onclick="app.games.close()" style="position:fixed; top:10px; right:10px; z-index:2001;">[X] –ó–ê–ö–†–´–¢–¨ –ì–†–£</button>
                    <div id="ruffle-host" style="width:100%; height:100%;"></div>
                </div>
            </div>

            <div id="page-css" class="page">
                <div class="glass" style="padding:20px; border-radius:12px;">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                    <p style="font-size:12px;">–¢–≤–æ–π CSS –∫–æ–¥ —É–≤–∏–¥—è—Ç –≤—Å–µ, –∫—Ç–æ –∑–∞–π–¥–µ—Ç –Ω–∞ —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.</p>
                    <textarea id="css-editor" style="width:100%; height:250px; font-family:monospace;"></textarea>
                    <button class="btn-aero" style="width:100%; margin-top:10px;" onclick="app.user.update('css', document.getElementById('css-editor').value)">–°–û–•–†–ê–ù–ò–¢–¨ –ö–û–î</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="modal-settings" class="glass" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:11000; padding:30px; border-radius:20px; width:300px;">
    <h2 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <b>–¢–µ–º–∞ —Å–∏—Å—Ç–µ–º—ã:</b>
    <select id="select-theme" onchange="app.ui.setTheme(this.value)" style="width:100%; margin:10px 0;">
        <option value="aero">Aero Classic (Blue)</option>
        <option value="dark">Dark Glass (Black)</option>
        <option value="xp">Luna XP (Green/Blue)</option>
        <option value="royal">Royal Purple</option>
        <option value="frost">White Frost</option>
    </select>
    <b>–≠—Ñ—Ñ–µ–∫—Ç—ã:</b>
    <select id="select-fx" onchange="app.fx.set(this.value)" style="width:100%; margin:10px 0;">
        <option value="none">–ù–µ—Ç</option>
        <option value="snow">–°–Ω–µ–≥</option>
        <option value="rain">–î–æ–∂–¥—å</option>
        <option value="stars">–ó–≤–µ–∑–¥—ã</option>
    </select>
    <button class="btn-aero" style="width:100%" onclick="this.parentElement.style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<div id="modal-profile" class="glass" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:11000; padding:40px; border-radius:25px; text-align:center; min-width:300px;">
    <img id="prof-ava" src="" style="width:120px; height:120px; border-radius:50%; border:5px solid #fff;">
    <h2 id="prof-nick"></h2>
    <p id="prof-desc" style="font-style:italic;"></p>
    <div id="prof-actions"></div>
    <button class="btn-aero" style="margin-top:20px; background:#666" onclick="app.ui.closeProfile()">–í–ï–†–ù–£–¢–¨–°–Ø –ö –°–ï–ë–ï</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, query, orderBy, limit, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, update, push, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const fbCfg = {
        apiKey: "AIzaSyBDrzNL3_kaSCU38Oac9-7CarZgqRfc9pU",
        authDomain: "freenet-3ad3c.firebaseapp.com",
        projectId: "freenet-3ad3c",
        databaseURL: "https://freenet-3ad3c-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const fb = initializeApp(fbCfg);
    const db = getFirestore(fb);
    const rtdb = getDatabase(fb);

    const app = {
        state: { user: null, currentRoom: null, friends: [], viewNick: null },
        
        auth: async () => {
            const n = document.getElementById('auth-nick').value.trim().toLowerCase();
            const p = document.getElementById('auth-pass').value.trim();
            if(!n || !p) return;
            const uDoc = await getDoc(doc(db, "users", n));
            if(uDoc.exists()) {
                if(uDoc.data().pass === p) app.initUser(n, uDoc.data());
                else document.getElementById('auth-err').innerText = "–ü–∞—Ä–æ–ª—å –Ω–µ –≤–µ—Ä–µ–Ω";
            } else {
                const data = { pass: p, nick: n, ava: "", bg: "", desc: "–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!", css: "", theme: "aero", fx: "none" };
                await setDoc(doc(db, "users", n), data);
                app.initUser(n, data);
            }
        },

        initUser: (nick, data) => {
            app.state.user = { nick, ...data };
            app.state.viewNick = nick;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('my-nick').innerText = nick;
            app.user.apply(data);
            
            // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
            const oRef = ref(rtdb, 'online/' + nick);
            set(oRef, { ava: data.ava || "" });
            onDisconnect(oRef).remove();

            app.subs.init();
        },

        user: {
            update: async (f, v) => {
                await updateDoc(doc(db, "users", app.state.user.nick), { [f]: v });
                app.state.user[f] = v;
                if(app.state.viewNick === app.state.user.nick) app.user.apply(app.state.user);
            },
            apply: (data) => {
                document.body.style.backgroundImage = data.bg ? `url('${data.bg}')` : "url('https://wallpaperaccess.com/full/1155027.jpg')";
                document.getElementById('custom-css-style').innerText = data.css || "";
                if(data.nick === app.state.user.nick) {
                    document.getElementById('my-ava').src = data.ava || "https://via.placeholder.com/90";
                    document.getElementById('my-desc').innerText = data.desc;
                    document.getElementById('set-ava').value = data.ava;
                    document.getElementById('set-bg').value = data.bg;
                    document.getElementById('css-editor').value = data.css;
                }
            }
        },

        subs: {
            init: () => {
                // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç
                onSnapshot(query(collection(db, "chat"), orderBy("time", "asc"), limit(50)), s => {
                    const b = document.getElementById('chat-messages'); b.innerHTML = "";
                    s.forEach(d => {
                        const m = d.data();
                        const isMe = m.nick === app.state.user.nick;
                        b.innerHTML += `
                            <div class="msg-obj" id="msg-${d.id}">
                                <img src="${m.ava || 'https://via.placeholder.com/35'}" class="msg-ava" onclick="app.ui.viewProfile('${m.nick}')">
                                <div class="msg-body" onclick="app.chat.menu('${d.id}', '${m.nick}')">
                                    <div class="msg-nick">${m.nick}</div>
                                    ${m.text}
                                </div>
                            </div>
                        `;
                    });
                    b.scrollTop = b.scrollHeight;
                });

                // –û–Ω–ª–∞–π–Ω —Å–ø–∏—Å–æ–∫
                onValue(ref(rtdb, 'online'), s => {
                    const list = document.getElementById('online-list'); list.innerHTML = "";
                    if(s.exists()) {
                        Object.entries(s.val()).forEach(([nick, val]) => {
                            list.innerHTML += `<div style="padding:5px; cursor:pointer" onclick="app.ui.viewProfile('${nick}')">üü¢ ${nick}</div>`;
                        });
                    }
                });

                // –î—Ä—É–∑—å—è –∏ –∑–∞–ø—Ä–æ—Å—ã
                onSnapshot(doc(db, "users", app.state.user.nick), s => {
                    const d = s.data();
                    app.state.friends = d.friends || [];
                    app.ui.renderFriends();
                });

                onValue(ref(rtdb, `req/${app.state.user.nick}`), s => {
                    if(s.exists()) {
                        Object.entries(s.val()).forEach(([from, val]) => {
                            app.ui.toastFriend(from);
                        });
                    }
                });
            }
        },

        chat: {
            send: async () => {
                const i = document.getElementById('chat-input'); if(!i.value) return;
                await addDoc(collection(db, "chat"), { 
                    nick: app.state.user.nick, 
                    ava: app.state.user.ava, 
                    text: i.value, 
                    time: Date.now() 
                });
                i.value = "";
            },
            menu: async (id, nick) => {
                const isMe = nick === app.state.user.nick;
                const act = confirm(isMe ? "–£–¥–∞–ª–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö?" : "–£–¥–∞–ª–∏—Ç—å —É —Å–µ–±—è?");
                if(act) {
                    if(isMe) await deleteDoc(doc(db, "chat", id));
                    else document.getElementById('msg-'+id).style.display = 'none';
                }
            },
            typing: () => {
                set(ref(rtdb, `typing/${app.state.user.nick}`), true);
                setTimeout(() => remove(ref(rtdb, `typing/${app.state.user.nick}`)), 2000);
            }
        },

        ui: {
            tab: (id) => {
                document.querySelectorAll('.page, .tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById('page-'+id).classList.add('active');
                event.target.classList.add('active');
                if(id === 'paint') app.paint.init();
            },
            viewProfile: async (nick) => {
                const uDoc = await getDoc(doc(db, "users", nick));
                if(!uDoc.exists()) return;
                const d = uDoc.data();
                app.state.viewNick = nick;
                app.user.apply(d);
                
                const m = document.getElementById('modal-profile');
                m.style.display = 'block';
                document.getElementById('prof-ava').src = d.ava || "https://via.placeholder.com/120";
                document.getElementById('prof-nick').innerText = nick;
                document.getElementById('prof-desc').innerText = d.desc;
                
                const act = document.getElementById('prof-actions'); act.innerHTML = "";
                if(nick !== app.state.user.nick && !app.state.friends.includes(nick)) {
                    act.innerHTML = `<button class="btn-aero" onclick="app.ui.addFriend('${nick}')">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>`;
                }
            },
            closeProfile: () => {
                document.getElementById('modal-profile').style.display = 'none';
                app.state.viewNick = app.state.user.nick;
                app.user.apply(app.state.user);
            },
            addFriend: (n) => {
                set(ref(rtdb, `req/${n}/${app.state.user.nick}`), true);
                alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            },
            toastFriend: (from) => {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = 'toast glass';
                t.innerHTML = `
                    <b>–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è!</b><br>–û—Ç: ${from}
                    <div style="margin-top:10px">
                        <button onclick="app.ui.confirmFriend('${from}', true, this)">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button onclick="app.ui.confirmFriend('${from}', false, this)">–ù–µ—Ç</button>
                    </div>
                `;
                c.appendChild(t);
            },
            confirmFriend: async (from, ok, btn) => {
                remove(ref(rtdb, `req/${app.state.user.nick}/${from}`));
                if(ok) {
                    const myF = [...app.state.friends, from];
                    await updateDoc(doc(db, "users", app.state.user.nick), { friends: myF });
                    const hisDoc = await getDoc(doc(db, "users", from));
                    const hisF = [...(hisDoc.data().friends || []), app.state.user.nick];
                    await updateDoc(doc(db, "users", from), { friends: hisF });
                }
                btn.parentElement.parentElement.remove();
            },
            renderFriends: () => {
                const g = document.getElementById('friends-grid'); g.innerHTML = "";
                app.state.friends.forEach(f => {
                    g.innerHTML += `
                        <div class="room-card glass" onclick="app.ui.viewProfile('${f}')">
                            <b>${f}</b>
                        </div>
                    `;
                });
            },
            setTheme: (t) => {
                const s = document.getElementById('theme-logic-style');
                if(t === 'dark') s.innerText = ":root { --aero-bg: rgba(0,0,0,0.7); --aero-border: rgba(255,255,255,0.2); } body { color: #fff; }";
                else if(t === 'xp') s.innerText = ":root { --aero-bg: rgba(235, 236, 241, 0.9); --win-blue: #245dd7; }";
                else s.innerText = "";
            },
            openSettings: () => {
                document.getElementById('modal-settings').style.display = 'block';
            }
        },

        cinema: {
            createRoom: async () => {
                const n = prompt("–ò–º—è –∫–æ–º–Ω–∞—Ç—ã:");
                const p = prompt("–ü–∞—Ä–æ–ª—å:");
                if(n) {
                    const rRef = push(ref(rtdb, 'rooms'));
                    await set(rRef, { name: n, pass: p, host: app.state.user.nick, video: "" });
                    app.cinema.join(rRef.key, p);
                }
            },
            join: (id, p) => {
                onValue(ref(rtdb, `rooms/${id}`), s => {
                    const d = s.val();
                    if(d.pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
                    app.state.currentRoom = id;
                    document.getElementById('cinema-lobby').style.display = 'none';
                    document.getElementById('cinema-room').style.display = 'flex';
                    app.cinema.sync(d);
                });
            },
            sync: (d) => {
                const cont = document.getElementById('player-container');
                if(d.video) {
                    const id = d.video.match(/(?:v=|be\/|embed\/)([a-zA-Z0-9_-]{11})/);
                    if(id) cont.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id[1]}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
                }
            }
        },

        paint: {
            init: () => {
                const can = document.getElementById('paint-canvas');
                const ctx = can.getContext('2d');
                can.width = 2000; can.height = 2000;
                
                let draw = false;
                can.onmousedown = (e) => { draw = true; ctx.beginPath(); };
                can.onmousemove = (e) => {
                    if(!draw) return;
                    ctx.strokeStyle = document.getElementById('paint-color').value;
                    ctx.lineWidth = document.getElementById('paint-size').value;
                    ctx.lineCap = 'round';
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                };
                window.onmouseup = () => draw = false;
            }
        },

        fx: {
            set: (type) => { /* –õ–æ–≥–∏–∫–∞ —á–∞—Å—Ç–∏—Ü –Ω–∞ Canvas */ }
        },

        music: {
            toggle: () => { /* –õ–æ–≥–∏–∫–∞ –ø–ª–µ–µ—Ä–∞ */ }
        },

        games: {
            play: (slug) => {
                document.getElementById('game-stage').style.display = 'block';
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç Ruffle –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            },
            close: () => document.getElementById('game-stage').style.display = 'none'
        }
    };

    window.app = app;
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
</script>
</body>
</html>
